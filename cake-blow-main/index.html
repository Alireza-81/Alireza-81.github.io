<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Candle Blow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Normalize and your styles -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css"
    />
    <link rel="stylesheet" href="./style.css" />
    <!-- PrefixFree for vendor prefixes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prefixfree/1.0.7/prefixfree.min.js"></script>

    <style>
      /* Page tweaks (you can keep most styling in style.css) */
      body {
        margin: 0;
        min-height: 100vh;
        background-color: #e6dbd3; /* soft pastel background */
      }
      .ui-controls {
        position: fixed;
        top: 16px;
        right: 16px;
        display: flex;
        gap: 8px;
        z-index: 1000;
      }
      .ui-controls button {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #272761;
        background: #fff7f1;
        color: #383878;
        cursor: pointer;
      }
      .ui-controls button:hover {
        background: #fff;
      }
      .candle-count-display {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        top: 16px;
        padding: 6px 10px;
        border-radius: 8px;
        background: rgba(255,255,255,0.8);
        border: 1px solid rgba(0,0,0,0.1);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        z-index: 999;
      }
    </style>
  </head>

  <body>
    <!-- Candle count / greeting -->
    <div class="candle-count-display" aria-live="polite">
      Happy <span id="candleCount">0</span><span id="ordinalSuffix">th</span> Birthday Kimia!
    </div>

    <!-- Cake -->
    <div class="cake">
      <div class="plate"></div>
      <div class="layer layer-bottom"></div>
      <div class="layer layer-middle"></div>
      <div class="layer layer-top"></div>
      <div class="icing"></div>
      <div class="drip drip1"></div>
      <div class="drip drip2"></div>
      <div class="drip drip3"></div>
    </div>

    <!-- Controls -->
    <div class="ui-controls">
      <button id="shareBtn">share cake</button>
      <button id="resetLinkBtn">reset candles</button>
    </div>

    <!-- Your main app logic (spawning candles, etc.) -->
    <script src="script.js"></script>

    <!-- Full-screen confetti on first page open (no libraries) -->
    <script>
      (() => {
        const COLORS = ['#f94144','#f3722c','#f9c74f','#90be6d','#43aa8b','#577590','#e76f51','#e9c46a','#277da1'];
        let canvas, ctx, W, H, parts = [], started = false, t0;

        function resize() {
          W = window.innerWidth; H = window.innerHeight;
          canvas.width = W; canvas.height = H;
        }
        function rand(a,b){ return Math.random()*(b-a)+a; }

        function spawnOne() {
          parts.push({
            x: rand(0, W), y: rand(-50, -200),
            vx: rand(-1, 1), vy: rand(2, 5),
            size: rand(6, 12),
            color: COLORS[(Math.random()*COLORS.length)|0],
            rot: rand(0, Math.PI*2), vr: rand(-0.15, 0.15),
            tilt: rand(-1,1), vt: rand(0.05,0.12)
          });
        }

        function draw(ts) {
          if (!t0) t0 = ts;
          const elapsed = ts - t0;

          ctx.clearRect(0,0,W,H);

          // Burst for ~2.5s
          if (elapsed < 2500) for (let i=0;i<25;i++) spawnOne();

          parts.forEach(p => {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.05; // gravity
            p.rot += p.vr;
            p.tilt += p.vt;

            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot);
            ctx.globalAlpha = Math.max(0, 1 - elapsed/3000); // fade out over ~4s
            ctx.fillStyle = p.color;
            // slightly “wobbly” rectangle
            ctx.fillRect(-p.size/2 + Math.sin(p.tilt)*2, -p.size/2, p.size, p.size*0.6);
            ctx.restore();
          });

          // keep only on-screen pieces
          parts = parts.filter(p => p.y < H + 30);

          if (elapsed < 3200) requestAnimationFrame(draw);
          else {
            window.removeEventListener('resize', resize);
            canvas.remove();
          }
        }

        function launchConfetti() {
          if (started) return;
          started = true;
          canvas = document.createElement('canvas');
          canvas.style.cssText = 'position:fixed;inset:0;pointer-events:none;z-index:9999';
          document.body.appendChild(canvas);
          ctx = canvas.getContext('2d');
          resize();
          window.addEventListener('resize', resize);
          requestAnimationFrame(draw);
        }

        window.addEventListener('load', () => {
          // Show once per session; remove these 2 lines to show on every load
          if (sessionStorage.getItem('confettiShown')) return;
          sessionStorage.setItem('confettiShown','1');

          launchConfetti();
        });
      })();
    </script>

    <!-- Shareable-candles patch (URL encoding + reset) -->
    <script>
      (function () {
        const cake = document.querySelector('.cake');
        const candlePts = [];   // stores [x,y] (percent-encoded into URL)
        let restoring = false;

        // ----- helpers: encode/decode to URL hash as percentages -----
        function encode(pts, box) {
          const rect = box.getBoundingClientRect();
          return '#c=' + pts.map(([x, y]) => {
            const xp = Math.max(0, Math.min(1, x / rect.width));
            const yp = Math.max(0, Math.min(1, y / rect.height));
            return xp.toFixed(4) + '_' + yp.toFixed(4);
          }).join('-');
        }
        function decode(hash, box) {
          const m = hash.match(/#c=([0-9._\-]+)/);
          if (!m) return [];
          const rect = box.getBoundingClientRect();
          return m[1].split('-').map(p => {
            const [xp, yp] = p.split('_').map(Number);
            return [xp * rect.width, yp * rect.height];
          });
        }

        // ----- record user placements (don’t record while restoring) -----
        function recordClick(e) {
          if (restoring || !cake) return;
          const rect = cake.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          if (x >= 0 && y >= 0 && x <= rect.width && y <= rect.height) {
            candlePts.push([x, y]);
          }
        }
        cake?.addEventListener('click', recordClick, true);

        // ----- share: write positions to URL & (try to) copy -----
        function updateShareLink() {
          if (!cake) return;
          const urlWithHash = location.pathname + encode(candlePts, cake);
          history.replaceState(null, '', urlWithHash);
          if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(location.href).catch(() => {});
          }
          alert('Share link ready! (Copied to clipboard if allowed)');
        }
        document.getElementById('shareBtn')?.addEventListener('click', updateShareLink);

        // ----- reset: use script.js helper so array + counter reset correctly -----
        document.getElementById('resetLinkBtn')?.addEventListener('click', () => {
          if (typeof window.resetCandles === 'function') {
            window.resetCandles();        // removes DOM candles, clears internal array, updates count to 0
          } else {
            // fallback if script.js didn't load for some reason
            document.querySelectorAll('.candle, .flame, .spark').forEach(el => el.remove());
            const counter = document.getElementById('candleCount');
            if (counter) counter.textContent = '0';
          }
          // clear recorded positions for sharing
          candlePts.length = 0;
          // clear the URL hash so link starts clean
          history.replaceState(null, '', location.pathname);
        });

        // ----- restore on load: call your app’s candle spawner or simulate clicks -----
        function spawnAt(x, y) {
          if (typeof window.addCandleAt === 'function') return window.addCandleAt(x, y);
          const rect = cake.getBoundingClientRect();
          const evt = new MouseEvent('click', {
            clientX: rect.left + x,
            clientY: rect.top + y,
            bubbles: true
          });
          cake.dispatchEvent(evt);
        }

        window.addEventListener('load', () => {
          if (!cake) return;
          const pts = decode(location.hash, cake);
          if (!pts.length) return;
          restoring = true;
          requestAnimationFrame(() => {
            pts.forEach(([x, y]) => spawnAt(x, y));
            restoring = false;
          });
        });
      })();
    </script>

    <!-- Dynamic ordinal suffix for the birthday number -->
    <script>
      (function () {
        const countEl = document.getElementById('candleCount');
        const suffixEl = document.getElementById('ordinalSuffix');
        const container = document.querySelector('.candle-count-display');

        function ordinal(n) {
          n = Math.abs(parseInt(n, 10) || 0);
          const mod100 = n % 100;
          if (mod100 >= 11 && mod100 <= 13) return 'th';
          switch (n % 10) {
            case 1: return 'st';
            case 2: return 'nd';
            case 3: return 'rd';
            default: return 'th';
          }
        }

        function updateSuffix() {
          const n = parseInt(countEl.textContent, 10) || 0;
          const suf = ordinal(n);
          suffixEl.textContent = suf;
          container.setAttribute('aria-label', `Happy ${n}${suf} Birthday Kimia!`);
        }

        // Keep in sync with any changes to the number
        const obs = new MutationObserver(updateSuffix);
        obs.observe(countEl, { childList: true, characterData: true, subtree: true });

        // Initialize
        updateSuffix();

        // Optional helper if your script.js prefers to set both:
        window.setBirthdayCount = function (n) {
          countEl.textContent = String(n);
          updateSuffix();
        };
      })();
    </script>
  </body>
</html>
